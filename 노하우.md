# A.I. BEAT: Infinite Mix - 개발 노하우 (Troubleshooting Guide)

이 문서는 Unity 6 리듬 게임 개발 과정에서 겪은 문제들과 해결 방법을 정리한 것입니다.

---

## 1. Unity Editor 포커스 문제 (최우선!)

### 증상
- VSCode, 브라우저 등 다른 앱으로 전환하면 게임이 멈춤
- `Update()`, 코루틴(`yield return null`)이 모두 중단됨
- MCP WebSocket은 정상 응답 → 게임 루프만 멈추므로 진단이 어려움

### 원인
Unity Editor는 **포커스를 잃으면 게임 루프를 일시 중지**합니다.

### 해결법
```csharp
void Start()
{
    Application.runInBackground = true;
}
```

### 주의사항
- 이 설정 없이 MCP로 테스트하면, MCP 응답은 오지만 게임은 멈춘 상태
- "노트가 안 움직여요" 문제의 80%는 이것이 원인

---

## 2. 노트 렌더링이 안 보이는 문제

### 증상
- 노트가 스폰되지만 화면에 보이지 않음
- 로그에서는 `visible=False`로 표시

### 가능한 원인들

#### 2.1 Alpha 값 오버플로우
```csharp
// 잘못된 코드 (Alpha도 1.2배 됨!)
return new Color(0f, 0.8f, 0.82f) * 1.2f;

// 올바른 코드 (RGB만 곱하기)
return new Color(
    Mathf.Min(baseColor.r * intensity, 1f),
    Mathf.Min(baseColor.g * intensity, 1f),
    Mathf.Min(baseColor.b * intensity, 1f),
    1f  // Alpha는 항상 1.0
);
```

#### 2.2 Sorting Order 문제
```csharp
// 노트: sortingOrder = 100
// 배경: sortingOrder = -100 ~ -200
// 판정선 글로우: sortingOrder = 50
```

#### 2.3 Z Position 문제
```csharp
// 카메라가 Z=-10 위치
// 노트는 Z=-1 ~ 0 사이에 배치
// 배경은 Z=1 ~ 2 (카메라에서 멀리)
```

---

## 3. TextMeshPro 폰트 문제

### 증상
- 텍스트가 화면에 전혀 표시되지 않음
- 에러 메시지도 없음

### 원인
TMP Essential Resources가 임포트되지 않음

### 해결법
```csharp
// Editor 스크립트에서 자동 임포트
string tmpPath = "Packages/com.unity.ugui/Package Resources/TMP Essential Resources.unitypackage";
AssetDatabase.ImportPackage(tmpPath, false);
```

### 한국어 폰트 빌드 문제
- Dynamic SDF 에셋의 `m_ClearDynamicDataOnBuild: 1` 설정 확인
- APK 빌드 시 아틀라스가 비워져서 한국어가 □로 표시됨
- 해결: 런타임에서 TTF로부터 Dynamic 폰트 에셋 생성

---

## 4. UI 터치가 안 되는 문제 (raycastTarget)

### 증상
- ScrollRect, Button 등이 터치에 반응하지 않음

### 원인
장식용 Image의 `raycastTarget = true` (기본값)

### 해결법
```csharp
var img = go.AddComponent<Image>();
img.raycastTarget = false;  // 장식용 이미지는 반드시 false
```

### 체크리스트
- 배경 이미지: `raycastTarget = false`
- 오버레이: `raycastTarget = false`
- 이퀄라이저 바: `raycastTarget = false`
- ScrollRect Viewport에는 Image가 있어야 함 (투명이라도)

---

## 5. MCP Unity 사용 팁

### 5.1 instanceId 주의
```
get_gameobject의 instanceId는 **GameObject**의 ID
로그의 GetInstanceID()는 **Component**의 ID (다름!)
```

### 5.2 토큰 절약
```
get_console_logs에 includeStackTrace: false 필수
NoteSpawner, GameplayCanvas의 get_gameobject 결과는 매우 큼 (MB 단위)
```

### 5.3 Play Mode 진입/종료
```
execute_menu_item("AIBeat/Enter Play Mode")
execute_menu_item("AIBeat/Exit Play Mode")
```

### 5.4 MCP 연결 실패 시
- Play Mode 전환 직후 MCP가 재시작됨
- 3초 대기 후 재시도

---

## 6. 코루틴 vs Update

### 이 프로젝트의 선택: 코루틴
```csharp
private IEnumerator MoveCoroutine()
{
    while (gameObject.activeSelf)
    {
        // 이동 로직
        yield return null;  // Time.timeScale=0에도 실행됨
    }
}
```

### 장점
- `Time.timeScale = 0`에도 `yield return null`은 실행됨
- WaitForSecondsRealtime 사용 가능
- 컴포넌트별 독립적인 루프 관리

### 단점
- 코루틴 시작/중지 관리 필요
- 디버깅 시 호출 스택이 복잡함

---

## 7. Unity Editor Play Mode 주의사항

### 7.1 [InitializeOnLoad] 어트리뷰트
- Play Mode 간섭 가능
- 불필요하면 제거

### 7.2 DontDestroyOnLoad
- Editor에서 인스턴스 중복 문제 유발
- 단순 싱글톤으로 대체 권장

### 7.3 첫 프레임 Time.unscaledDeltaTime
- Play Mode 진입 시 2~3초로 매우 큼 (전환 시간)
- 초기화 로직에서 이 값 사용 주의

### 7.4 execute_menu_item 토글 주의
```
"Tools/A.I. BEAT/Play Game" 같은 토글 메뉴는
실행 중에 호출하면 중지됨
→ Enter/Exit 분리된 메뉴 사용 권장
```

---

## 8. 렌더링 레이어 구조 (권장)

```
Z축 (카메라에서 거리):
  카메라: Z = -10

  UI (Screen Space Overlay): 최상위

  판정 효과: Z = -2
  노트: Z = -1
  판정선 글로우: Z = 0.5
  레인 구분선: Z = 0.9
  파티클: Z = 1.5
  배경 그라데이션: Z = 2

Sorting Order:
  비트 플래시 오버레이: 200
  노트: 100
  판정선 글로우: 50
  레인 구분선: -30
  파티클: -50
  배경: -100
  SortingGroup (BackgroundVFX): -200
```

---

## 9. 성능 최적화 팁

### 9.1 오브젝트 풀링
- 노트는 풀링 사용 (NoteSpawner)
- 매 프레임 생성/파괴 금지

### 9.2 Material 인스턴스
```csharp
// 공유 Material 수정 시 인스턴스 생성됨
renderer.material.color = newColor;  // 인스턴스 생성!

// 직접 인스턴스 관리
_instanceMaterial = new Material(shader);
renderer.material = _instanceMaterial;
```

### 9.3 GetComponent 캐싱
```csharp
// 매 프레임 호출 금지
private Renderer _renderer;
void Awake() { _renderer = GetComponent<Renderer>(); }
```

---

## 10. 디버깅 체크리스트

노트가 안 보일 때:
1. [ ] Application.runInBackground = true?
2. [ ] Alpha 값이 1.0 초과하지 않는가?
3. [ ] Sorting Order가 배경보다 높은가?
4. [ ] Z Position이 카메라 앞에 있는가?
5. [ ] MeshRenderer.enabled = true?
6. [ ] Material이 null이 아닌가?
7. [ ] 색상이 투명하지 않은가?

게임이 멈출 때:
1. [ ] Unity Editor 포커스 확인
2. [ ] Time.timeScale > 0?
3. [ ] 무한 루프 없는가?
4. [ ] 코루틴이 시작되었는가?

UI가 안 보일 때:
1. [ ] TMP Essential Resources 임포트?
2. [ ] 폰트 에셋이 null이 아닌가?
3. [ ] Canvas가 활성화되어 있는가?
4. [ ] 텍스트 색상이 투명하지 않은가?

---

## 버전 기록

- 2026-02-16: 초기 작성 (Phase 2 완료 기준)
- Alpha 오버플로우 문제 해결
- BackgroundVFX 네온 스타일 리디자인
